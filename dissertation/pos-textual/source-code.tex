\chapter{Source Code}
\label{ch:source-code}

\Section{Nanvix Project Structure}
\label{sec:code-structure}

O código fonte deste trabalho está incluído no desenvolvimento de um sistema
operacional distribuído de proprósito geral para processadores lightweight manycores,
denominado Nanvix OS. O Nanvix OS é o resultado de um projeto de código aberto
e colaborativo disponibilizado na plataforma Github. O Projeto Nanvix é detalhado em
maiores detalhes nas Seções A, B, C.

Existe um repositório separado no Github para cada camada de abstração que é mantido
e atualizado pelos colaboradores do Nanvix. A dependência das camadas superiores é
resolvido através do uso de submódulos, suportado pelo git. Por meio dos submódulos,
é criado de forma implicita um hieraquia de dependências por entre os repositórios do Nanvix.
Deste modo, cada camada que dependa e utilize outra camada tem garantias de seu funcionamento
mas é isento de sua implementação. Isto torna os códigos mais bem gerenciáveis, modulares e,
por consequência, melhores portáveis. Para garantir a correta implementação das interfaces
exportadas nas diversas arquiteturas suportadas, todos os repositórios contém conjuntos de
testes, \ie testes API e FAULT.

A implementação referente a está dissertação é dividada em quatro repositórios, ordenados por
depênciancia (Microkernel-Benchmarks -> LibNanvix -> Microkernel -> HAL):

- Microkernel-Benchmarks: Contém a implementação dos micro-benchmarks que estimulam os serviços
de comunicação. Especificamente, existem quatro micro-benchmarks para cada serviço de transferência de dados,
isto é, mailbox e portal. Neste repositório também existem scripts para compilação e executação dos
experimentos na plataforma do \mppa. A branch que contém a implementação está nomeada de collective-comm-routines.

- LibNanvix: complemento do microkernel, este repositório exporta e implementa a interface
de usuário das chamadas de sistemas.

- Microkernel: implementação de parte do microkernel assíncrono detalhado na Seção 2.
Este repositório contém toda as estruturas internas do SO e a implementação das chamadas
do lado do núcleo mestre.

- HAL: define e implementa as interfaces das abstrações de mais baixo nível.
ste repositório lida diretamente com as diversas arquiteturas suportadas, entre elas,
\mppa, \optimsoc, \hero e uma implementação para testes sobre o sistema operacional \unix.
Maiores detalhes na Seção 1.

Os Links para acessar cada um dos repositórios é:

- Microkernel-Benchmarks:\url{https://github.com/joaovicentesouto/microkernel-benchmarks/tree/collective-comm-routines}
- LibNanvix:\url{https://github.com/nanvix/libnanvix}
- Microkernel:\url{https://github.com/nanvix/microkernel}
- HAL:\url{https://github.com/nanvix/hal}

\Section{Version of the Source Code}
\label{sec:code-version}

Todos os repositórios seguem um convenção na nomenclatura dos branchs, onde apenas duas branchs
são, de fato, importantes.
Primeiro, a branch master contém a versão mais estável do sistema e marca os grandes releases das versões do Nanvix.
Segundo, a branch unstable contém a versão mais atual, porém, ainda podem existir bugs e partes importantes faltando.
As demais branchs são destinadas a implementar novos recursos, melhorar os existentes ou resolver bugs.
Essas outras branchs são incorporadas a branch unstable quando estiverem passando em todos os testes de regressão.

O código fonte desta dissertação está contido nos referentes commits do Github:

- Microkernel-Benchmarks: aafd9a70f8188105efabd651050bc7cafc39d343
-- microkernel-benchmarks/include/kbench.h
-- microkernel-benchmarks/src/utils/args.c
-- microkernel-benchmarks/src/utils/barrier.c
-- microkernel-benchmarks/src/utils/crt0.c
-- microkernel-benchmarks/src/utils/node.c
-- microkernel-benchmarks/src/utils/results.c
-- microkernel-benchmarks/src/utils/string.c
-- microkernel-benchmarks/src/utils/times.c
-- microkernel-benchmarks/src/mailbox/allgather/main.c
-- microkernel-benchmarks/src/mailbox/broadcast/main.c
-- microkernel-benchmarks/src/mailbox/gather/main.c
-- microkernel-benchmarks/src/mailbox/pingpong/main.c
-- microkernel-benchmarks/src/portal/allgather/main.c
-- microkernel-benchmarks/src/portal/broadcast/main.c
-- microkernel-benchmarks/src/portal/gather/main.c
-- microkernel-benchmarks/src/portal/pingpong/main.c
- LibNanvix: a9dcb35dd8727aefe41d316ac2609c88073e160e
-- libnanvix/include/nanvix/mailbox.h
-- libnanvix/include/nanvix/noc.h
-- libnanvix/include/nanvix/portal.h
-- libnanvix/include/nanvix/sync.h
-- libnanvix/src/libnanvix/ikc/mailbox.c
-- libnanvix/src/libnanvix/ikc/noc.c
-- libnanvix/src/libnanvix/ikc/portal.c
-- libnanvix/src/libnanvix/ikc/sync.c
-- libnanvix/src/test/kmailbox.c
-- libnanvix/src/test/knoc.c
-- libnanvix/src/test/kportal.c
-- libnanvix/src/test/ksync.c
- Microkernel: a9826dec62baa3fe47ab3a77b15f3ccfdd84b79a
-- microkernel/include/nanvix/mailbox.h
-- microkernel/include/nanvix/noc.h
-- microkernel/include/nanvix/portal.h
-- microkernel/include/nanvix/syscall.h
-- microkernel/src/kernel/noc/mailbox.c
-- microkernel/src/kernel/noc/portal.c
-- microkernel/src/kernel/noc/sync.c
- HAL: 1e7d3bc64decff023ac91cdecc2e0ac6c53ac946
-- hal/include/nanvix/hal/target/mailbox.h
-- hal/include/nanvix/hal/target/portal.h
-- hal/include/nanvix/hal/target/sync.h
-- hal/include/nanvix/hal/processor/clusters.h
-- hal/include/nanvix/hal/processor/noc.h
-- hal/include/arch/target/kalray/mppa256/mailbox.h
-- hal/include/arch/target/kalray/mppa256/portal.h
-- hal/include/arch/target/kalray/mppa256/sync.h
-- hal/include/arch/processor/bostan/clusters.h
-- hal/include/arch/processor/bostan/noc.h
-- hal/include/arch/processor/bostan/noc/tag.h
-- hal/include/arch/processor/bostan/noc/ctag.h
-- hal/include/arch/processor/bostan/noc/dtag.h
-- hal/include/arch/processor/bostan/noc/dma.h
-- hal/src/hal/arch/target/mppa256/mailbox.c
-- hal/src/hal/arch/target/mppa256/portal.c
-- hal/src/hal/arch/target/mppa256/sync.c
-- hal/src/hal/arch/processor/bostan/clusters.c
-- hal/src/hal/arch/processor/bostan/noc.c
-- hal/src/hal/arch/processor/bostan/ctag.c
-- hal/src/hal/arch/processor/bostan/dtag.c
-- hal/src/hal/arch/processor/bostan/dma.c
-- hal/src/test/target/mailbox.c
-- hal/src/test/target/portal.c
-- hal/src/test/target/sync.c
-- hal/src/test/processor/clusters.c
-- hal/src/test/processor/cnoc.c
-- hal/src/test/processor/dnoc.c
-- hal/src/test/processor/noc.c

\Section{Exemplo de executação dos testes de regressão}
\label{sec:code-example}

O Código X exemplifica o download do código fonte da LibNanvix, sua compilação para a plataforma \mppa, e
a executação dos testes de regressão.

% \begin{description}
    
% \end{description}

% export TARGET=mppa256
% cd $HOME
% git clone --recursive https://github.com/nanvix/libnanvix.git $HOME/libnanvix
% cd libnanvix
% git submodule update --init --recursive
% make contrib
% make all
% make run-ccluster KERNEL=hello-world
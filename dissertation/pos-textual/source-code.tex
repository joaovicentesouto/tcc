\chapter{Source Code}
\label{ch:source-code}

% \let\svaddcontentsline\addcontentsline
% \renewcommand\addcontentsline[3]{%
%   \ifthenelse{\equal{#1}{lof}}{}%
%   {\ifthenelse{\equal{#1}{lot}}{}{\svaddcontentsline{#1}{#2}{#3}}}}

% \renewcommand\thefigure{\thesection.\arabic{figure}}

% \counterwithin{figure}{section}

\renewcommand{\thefigure}{B-\arabic{figure}}
\setcounter{figure}{0}

\section{Nanvix Project Structure}

    The development of a general-purpose distributed operating system for
    lightweight manycores processors, called \nanvixos, includes the source
    code for this undergraduate dissertation. \nanvixos is the result of an
    open-source, collaborative project made available on the Github platform.
    Since it is not semantically interesting to have only part of the source
    code and it is impossible to insert all OS code into this document, this
    appendix details where find and test the developed code. The Nanvix
    Project is detailed in \autoref{sec.nanvix}.

    Specifically, there is a separate Github repository for each abstraction
    layer that is maintained and updated by Nanvix contributors. Submodules,
    supported by the git tool, create an implicit dependency hierarchy
    between the Nanvix repositories. Thus, each layer that depends on another
    has guarantees of its operation and is exempt from its implementation.
    Theses guarantees make the codes better manageable, modular, and better
    portable. All repositories contain test sets (Validation and Fault tests)
    to ensure the correct implementation of exported interfaces on the several
    supported architectures.

    All repositories follow a branch naming convention, where only two
    branches are, in fact, essential. First, the master branch contains
    the most stable version of the system and marks the significant
    releases of Nanvix versions. Second, the unstable branch contains
    the most current version, but there may still exist bugs or required
    parts missing. The other branches are intended to implement new features,
    improve existing ones, or fix bugs. These other branches are merged
    into the unstable branch when passing all regression tests.

    The following subsections, ordered by dependency, detail the four
    repositories that contain the source code of this undergraduate dissertation.

    \subsection{Microkernel-Benchmarks}
    
        The \textit{Microkernel-Benchmarks} implements the micro-benchmarks
        that stimulate communication services. Specifically, there are four
        micro-benchmarks for each data transfer service, detailed in
        \autoref{sec.evaluation-methodology}. In this repository, there
        are also scripts for compiling and running experiments on the
        \mppa platform.

        The developed code version are available at
        \url{https://github.com/joaovicentesouto/microkernel-benchmarks},
        in the \textit{collective-comm-routines branch} or, especificaty,
        in the \textit{commit aafd9a70f8188105efabd651050bc7cafc39d343}.
        \autoref{fig:tree.benchs} presents, in the form of a file system
        tree, all files that are fully, or partially, developed. The
        \textit{include} folder contains only one file with static
        experiment settings. The \textit{src} folder is made up of
        auxiliary files and the micro-benchmarks themselves.

        \begin{figure}[!ht]
            \centering%
            \begin{forest}
            for tree={
                grow'=0,
                parent anchor=children,
                child anchor=parent,
                anchor=parent,
            },
            where level=0{
                draw
            }{
                if={(n()==1)&&(level()>1)}{
                calign with current edge
                }{},
                if n children=0{folder}{},
                edge path'={(!u.parent anchor) -- ++(5pt,0) |- (.child anchor)},
            }
            [microkernel-benchmarks
                [include
                    [kbench.h]
                ]
                [src
                    [utils
                        [args.c]
                        [barrier.c]
                        [crt0.c]
                        [node.c]
                        [results.c]
                        [string.c]
                        [times.c]
                    ]
                    [mailbox
                        [allgather/main.c]
                        [broadcast/main.c]
                        [gather/main.c]
                        [pingpong/main.c]
                    ]
                    [portal
                        [allgather/main.c]
                        [broadcast/main.c]
                        [gather/main.c]
                        [pingpong/main.c]
                    ]
                ]
            ]
            \end{forest}%
            \caption{Source tree.}%
            \label{fig:tree.benchs}%
        \end{figure}

    \subsection{LibNanvix}

        LibNanvix defines and exports user interfaces for Nanvix Microkernel
        services. Implementations, in turn, have the responsibility of making
        requests to the master core through the kernel call interface exported
        by the microkernel repository, detailed in \autoref{sec.microkernel}.
        Briefly, this repository is the complement of the Microkernel repository.

        \autoref{fig:tree.libnanvix} illustrates, as a file system tree,
        all files developed of the communication abstraction user
        interface. First, the files in the \textit{include} folder
        define the user interfaces. Second, files within the
        \textit{ikc} folder perform checks to identify potential
        problems. Finally, the test folder contains the validation
        and correctness tests of user abstractions. The code version
        is available in \textit{commit a9dcb35dd8727aefe41d316ac2609c88073e160e}
        at \url{https://github.com/nanvix/libnanvix}.

        \begin{figure}[!ht]
            \centering%
            \begin{forest}
            for tree={
                grow'=0,
                parent anchor=children,
                child anchor=parent,
                anchor=parent,
            },
            where level=0{
                draw
            }{
                if={(n()==1)&&(level()>1)}{
                calign with current edge
                }{},
                if n children=0{folder}{},
                edge path'={(!u.parent anchor) -- ++(5pt,0) |- (.child anchor)},
            }
            [libnanvix
                [include/nanvix
                    [mailbox.h]
                    [noc.h]
                    [portal.h]
                    [sync.h]
                ]
                [src
                    [libnanvix/ikc
                        [mailbox.c]
                        [noc.c]
                        [portal.c]
                        [sync.c]
                    ]
                    [test
                        [kmailbox.c]
                        [knoc.c]
                        [kportal.c]
                        [ksync.c]
                    ]
                ]
            ]
            \end{forest}%
            \caption{Source tree.}%
            \label{fig:tree.libnanvix}%
        \end{figure}

    \subsection{Microkernel}
    
        implements of part of the asynchronous microkernel
        detailed in \autoref{sec.microkernel}. This repository contains all
        internal \os structures and the implementation of master-side calls.
        Available at \url{https://github.com/nanvix/microkernel}.

        % \begin{itemize}
        %     \item Microkernel: a9826dec62baa3fe47ab3a77b15f3ccfdd84b79a
        %     \item microkernel/include/nanvix/mailbox.h
        %     \item microkernel/include/nanvix/noc.h
        %     \item microkernel/include/nanvix/portal.h
        %     \item microkernel/include/nanvix/syscall.h
        %     \item microkernel/src/kernel/noc/mailbox.c
        %     \item microkernel/src/kernel/noc/portal.c
        %     \item microkernel/src/kernel/noc/sync.c
        % \end{itemize}
        \begin{figure}[!ht]
            \centering%
            \begin{forest}
            for tree={
                grow'=0,
                parent anchor=children,
                child anchor=parent,
                anchor=parent,
            },
            where level=0{
                draw
            }{
                if={(n()==1)&&(level()>1)}{
                calign with current edge
                }{},
                if n children=0{folder}{},
                edge path'={(!u.parent anchor) -- ++(5pt,0) |- (.child anchor)},
            }
            [microkernel
                [include/nanvix
                    [mailbox.h]
                    [noc.h]
                    [portal.h]
                    [sync.h]
                ]
                [src/kernel/noc
                    [mailbox.c]
                    [portal.c]
                    [sync.c]
                ]
            ]
            \end{forest}
            \caption{Source tree.}
        \end{figure}

    \subsection{HAL}
    
        defines and implements the interfaces of the lowest level
        abstractions. This repository deals directly with the multiple
        supported architectures, including \mppa, \optimsoc, \hero, and a
        \unix implementation for testing. More details in \autoref{sec.hal}.
        Available at \url{https://github.com/nanvix/hal}.

        % \begin{itemize}
        %     \item HAL: 1e7d3bc64decff023ac91cdecc2e0ac6c53ac946
        %     \item hal/include/nanvix/hal/target/mailbox.h
        %     \item hal/include/nanvix/hal/target/portal.h
        %     \item hal/include/nanvix/hal/target/sync.h
        %     \item hal/include/nanvix/hal/processor/clusters.h
        %     \item hal/include/nanvix/hal/processor/noc.h
        %     \item hal/include/arch/target/kalray/mppa256/mailbox.h
        %     \item hal/include/arch/target/kalray/mppa256/portal.h
        %     \item hal/include/arch/target/kalray/mppa256/sync.h
        %     \item hal/include/arch/processor/bostan/clusters.h
        %     \item hal/include/arch/processor/bostan/noc.h
        %     \item hal/include/arch/processor/bostan/noc/tag.h
        %     \item hal/include/arch/processor/bostan/noc/ctag.h
        %     \item hal/include/arch/processor/bostan/noc/dtag.h
        %     \item hal/include/arch/processor/bostan/noc/dma.h
        %     \item hal/src/hal/arch/target/mppa256/mailbox.c
        %     \item hal/src/hal/arch/target/mppa256/portal.c
        %     \item hal/src/hal/arch/target/mppa256/sync.c
        %     \item hal/src/hal/arch/processor/bostan/clusters.c
        %     \item hal/src/hal/arch/processor/bostan/noc.c
        %     \item hal/src/hal/arch/processor/bostan/ctag.c
        %     \item hal/src/hal/arch/processor/bostan/dtag.c
        %     \item hal/src/hal/arch/processor/bostan/dma.c
        %     \item hal/src/test/target/mailbox.c
        %     \item hal/src/test/target/portal.c
        %     \item hal/src/test/target/sync.c
        %     \item hal/src/test/processor/clusters.c
        %     \item hal/src/test/processor/cnoc.c
        %     \item hal/src/test/processor/dnoc.c
        %     \item hal/src/test/processor/noc.c
        % \end{itemize}
        \begin{figure}[!ht]
            \centering%
            \begin{forest}
            for tree={
                grow'=0,
                parent anchor=children,
                child anchor=parent,
                anchor=parent,
            },
            where level=0{
                draw
            }{
                if={(n()==1)&&(level()>1)}{
                calign with current edge
                }{},
                if n children=0{folder}{},
                edge path'={(!u.parent anchor) -- ++(5pt,0) |- (.child anchor)},
            }
            [hal
                [include
                    [nanvix/hal
                            [processor
                                [noc.h]
                                [clusters.h]
                            ]
                            [target
                                [mailbox.h]
                                [portal.h]
                                [sync.h]
                            ]
                    ]
                    [hal/arch
                        [processor/bostan
                            [noc.h]
                            [clusters.h]
                            [noc
                                [tag.h]
                                [ctag.h]
                                [dtag.h]
                                [dma.h]
                            ]
                        ]
                        [target/kalray/mppa256
                            [mailbox.h]
                            [portal.h]
                            [sync.h]
                        ]
                    ]
                ]
                [src
                    [hal/arch
                            [processor/bostan
                                [dma.c]
                                [noc.c]
                                [ctag.c]
                                [dtag.c]
                                [clusters.c]
                            ]
                            [target/mppa256
                                [mailbox.c]
                                [portal.c]
                                [sync.c]
                            ]
                    ]
                    [test
                        [processor
                            [noc.c]
                            [cnoc.c]
                            [dnoc.c]
                            [clusters.c]
                        ]
                        [target
                            [mailbox.c]
                            [portal.c]
                            [sync.c]
                        ]
                    ]
                ]
            ]
            \end{forest}
            \caption{Source tree.}
        \end{figure}

    % The links to access each of the repositories are:

    % \begin{description}
    %     \item[Microkernel-Benchmarks] \url{https://github.com/joaovicentesouto/microkernel-benchmarks/tree/collective-comm-routines}
    %     \item[LibNanvix] \url{https://github.com/nanvix/libnanvix}
    %     \item[Microkernel] \url{https://github.com/nanvix/microkernel}
    %     \item[HAL] \url{https://github.com/nanvix/hal}
    % \end{description}

\section{Exemplo de executação dos testes de regressão}
\label{sec:code-example}

O Código X exemplifica o download do código fonte da LibNanvix, sua compilação para a plataforma MPPA, e a executação dos testes de regressão.

% \begin{description}
    
% \end{description}

% export TARGET=mppa256
% cd $HOME
% git clone --recursive https://github.com/nanvix/libnanvix.git $HOME/libnanvix
% cd libnanvix
% git submodule update --init --recursive
% make contrib
% make all
% make run-ccluster KERNEL=hello-world